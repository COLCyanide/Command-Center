<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Command Center Sync Frame</title>
</head>
<script>
  window.addEventListener("message", async (event) => {
    if (event.origin !== "https://your-origin.com") return;
    const { action, binId, masterKey, accessKey, content } = event.data;

    const headers = {
      "Content-Type": "application/json",
    };

    try {
      if (action === "pushToBin") {
        headers["X-Master-Key"] = masterKey;
        const res = await fetch(`https://api.jsonbin.io/v3/b/${binId}`, {
          method: "PUT",
          headers,
          body: JSON.stringify(content),
        });
        const json = await res.json();
        event.source.postMessage({ status: "success", data: json }, event.origin);
      }

      else if (action === "appendToBin") {
        headers["X-Master-Key"] = masterKey;
        const current = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, {
          headers: { ...headers, "X-Access-Key": accessKey },
        });
        const json = await current.json();
        const newData = (json.record || "") + "\\n" + content;

        const update = await fetch(`https://api.jsonbin.io/v3/b/${binId}`, {
          method: "PUT",
          headers,
          body: JSON.stringify(newData),
        });
        const updated = await update.json();
        event.source.postMessage({ status: "success", data: updated }, event.origin);
      }

      else if (action === "pullFromBin") {
        const res = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, {
          headers: {
            ...headers,
            "X-Access-Key": accessKey,
          },
        });
        const json = await res.json();
        event.source.postMessage({ status: "success", data: json }, event.origin);
      }

      else {
        event.source.postMessage({ status: "error", message: "Unknown action" }, event.origin);
      }
    } catch (err) {
      event.source.postMessage({ status: "error", message: err.message }, event.origin);
    }
  });
</script>
</body>
</html>
